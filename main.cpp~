#include "ABC.h"
#include "RuleBuilder.h"

int main(int argc,char* argv[])
{
    string rule = "(department= sale || department = human) && sex = man";
    RuleBuilder ruleBuilder = RuleBuilder(rule);

    TiXmlElement *ruleXml = ruleBuilder.RuleString2XMLElement();

    vector<string> *atrs = new vector<string>();
    atrs->push_back("human");
    atrs->push_back("man");
    atrs->push_back("1");
    atrs->push_back("2");
    atrs->push_back("3");
    atrs->push_back("4");
    

    vector<string> *atrsDelegate = new vector<string>();
    atrsDelegate->push_back("human");
    atrsDelegate->push_back("man");
    atrsDelegate->push_back("ear");

    BN_CTX *ctx = BN_CTX_new();
    EC_GROUP * group = EC_GROUP_init(ctx);

    ABC abc = ABC(group);

    ABCMK abcMK = abc.GetMK();
  
    //cout<<xml2string(element_wrap(abcMK.ToTiXmlElement()))<<endl;
    
    ABCPK abcPK = abc.GetPK();
    //cout<<xml2string(element_wrap(abcPK.ToTiXmlElement()))<<endl;
    ABCSK abcSK = abc.GenerateABCSK(atrs);
    //cout<<xml2string(element_wrap(abcSK.ToTiXmlElement()))<<endl;

    char src[100]     = "/home/jinhz/Desktop/PBC.pdf";
    char cTarget[100] = "/home/jinhz/Desktop/CPBC.pdf";
    char pTarget[100] = "/home/jinhz/Desktop/PPBC.pdf";

    ABCEBLOCK eblock = abc.EncryptFile(src,cTarget,ruleXml);

    //cout<<xml2string(element_wrap(eblock.ToTiXmlElement()))<<endl;

    abc.SetSK(abcSK);

    ABCSK sk = abc.Delegate(atrsDelegate);

    abc.SetSK(sk);
    //cout<<xml2string(element_wrap(sk.ToTiXmlElement()))<<endl;
    abc.DecryptFile(cTarget,pTarget,ruleXml,eblock);
    string skString = xml2string(element_wrap(sk.ToTiXmlElement()));
    cout<<skString<<endl;

}
